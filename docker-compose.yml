# ============================================
# docker-compose.yml - Saborea Colombia
# ============================================
# Ubicación: saboreaColombia/ (raíz del proyecto)
# Servicios: PostgreSQL 15 + NestJS API
# ============================================

version: '3.8'

services:
  # ============================================
  # SERVICIO: PostgreSQL 15
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: saborea_postgres
    
    # Variables de entorno para PostgreSQL
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: saborea_colombia_db
      PGDATA: /var/lib/postgresql/data/pgdata
    
    # Puertos
    ports:
      - "5432:5432"
    
    # Volumen para persistencia de datos
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # Network compartida
    networks:
      - saborea_network
    
    # Health check solo para PostgreSQL (mantenemos este)
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SERVICIO: NestJS API Backend
  # ============================================
  api:
    build:
      context: ./back
      dockerfile: Dockerfile
    
    container_name: saborea_api
    
    # Dependencia en PostgreSQL
    depends_on:
      postgres:
        condition: service_healthy
    
    # Variables de entorno para NestJS
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3000}
      
      # Configuración de Base de Datos
      DB_HOST: postgres  # ⚠️ IMPORTANTE: nombre del servicio, no localhost
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-password}
      DB_DATABASE: ${DB_DATABASE:-saborea_colombia_db}
      DB_SYNCHRONIZE: ${DB_SYNCHRONIZE:-true}
      DB_LOGGING: ${DB_LOGGING:-false}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-your_super_secret_jwt_key_min_32_characters_12345}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}
      
      # Swagger
      SWAGGER_TITLE: ${SWAGGER_TITLE:-Saborea Colombia API}
      SWAGGER_DESCRIPTION: ${SWAGGER_DESCRIPTION:-Directorio Gastronómico de Colombia}
      SWAGGER_VERSION: ${SWAGGER_VERSION:-1.0.0}
    
    # Puertos
    ports:
      - "${PORT:-3000}:3000"
    
    # Volumen para hot-reload en desarrollo
    volumes:
      - ./back:/app
      - /app/node_modules
    
    # Network compartida
    networks:
      - saborea_network
    
    # ⚠️ ELIMINADO: Health check de la API (para desarrollo)
    # Reinicio automático
    restart: unless-stopped
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================
# VOLÚMENES PERSISTENTES
# ============================================
volumes:
  postgres_data:
    driver: local

# ============================================
# NETWORKS PERSONALIZADAS
# ============================================
networks:
  saborea_network:
    driver: bridge